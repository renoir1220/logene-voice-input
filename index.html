<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="/src/styles.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>朗珈语音输入法</title>
  <script type="module" src="/src/main.ts" defer></script>
</head>

<body>
  <div id="app">
    <!-- 视图 1：Typeless 式横向胶囊悬浮窗 -->
    <div id="float-capsule-view" class="view active">
      <div class="capsule-container">
        <button id="record-btn" class="capsule-btn" title="点击录音 / Alt+Space 按住 / 双击或右键打开配置">
          <div class="idle-dots">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          </div>
          <div class="wave-bars">
            <span class="bar"></span><span class="bar"></span><span class="bar"></span>
          </div>
        </button>
        <button id="vad-toggle-btn" class="vad-toggle-btn" title="VAD 监听开关 (Alt+Shift+V)" aria-pressed="false">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" aria-hidden="true">
            <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3z" />
            <path
              d="M17 11a1 1 0 1 1 2 0 7 7 0 0 1-6 6.93V21h2a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2h2v-3.07A7 7 0 0 1 5 11a1 1 0 1 1 2 0 5 5 0 1 0 10 0z" />
          </svg>
        </button>
        <span id="status-text" class="status-text">就绪</span>
      </div>
      <div id="error-bar" class="error-bar"></div>
    </div>

    <!-- 视图 2：主界面控制台 -->
    <div id="main-dashboard-view" class="view">
      <div class="dashboard-body">
        <!-- 侧边栏（同时整块负责窗口拖动部分） -->
        <div class="sidebar">
          <div class="sidebar-brand">
            <img class="sidebar-brand-logo" src="/brand/langia-logo.png" alt="朗珈语音输入法" />
            <div class="sidebar-brand-title">朗珈语音输入法</div>
          </div>
          <button class="menu-item active" data-tab="status">
            <svg viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z" />
              <path d="M7 12h2v5H7zm4-3h2v8h-2zm4-4h2v12h-2z" />
            </svg>状态与统计
          </button>
          <button class="menu-item" data-tab="settings">
            <svg viewBox="0 0 24 24">
              <path
                d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.73,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.43-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.49-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
            </svg>首选项
            <span id="settings-model-warning" class="menu-warning-icon" hidden title="检测到本地模型下载不完整">⚠</span>
          </button>
          <button class="menu-item" data-tab="llm">
            <svg viewBox="0 0 24 24">
              <path
                d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18-.21 0-.41-.06-.57-.18l-7.9-4.44A.991.991 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18.21 0 .41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9zM12 4.15L6.04 7.5 12 10.85l5.96-3.35L12 4.15zM5 15.91l6 3.38v-6.71L5 9.21v6.7zm14 0v-6.7l-6 3.38v6.71l6-3.38z" />
            </svg>模型与任务
          </button>
          <button class="menu-item" data-tab="history">
            <svg viewBox="0 0 24 24">
              <path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z" />
            </svg>对话记录
          </button>
          <button class="menu-item" data-tab="logs">
            <svg viewBox="0 0 24 24">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
            </svg>日志
          </button>
        </div>

        <!-- 内容主区 -->
        <div class="content">
          <div class="content-header">
          </div>
          <!-- 状态页 -->
          <div id="tab-status" class="tab-pane active">
            <h2 class="page-title">运行状态</h2>
            <div class="card-grid">
              <div class="stat-card">
                <div id="stat-engine" class="stat-value">就绪</div>
                <div class="stat-label">引擎状态</div>
              </div>
              <div class="stat-card">
                <div id="stat-today-count" class="stat-value">--</div>
                <div class="stat-label">今日听写次数</div>
              </div>
              <div class="stat-card">
                <div id="stat-today-chars" class="stat-value">--</div>
                <div class="stat-label">今日字符数</div>
              </div>
              <div class="stat-card">
                <div id="stat-total-count" class="stat-value">--</div>
                <div class="stat-label">累计听写次数</div>
              </div>
            </div>
            <div class="card">
              <h3>VAD 连续识别模式</h3>
              <p class="desc">持续聆听，说完即转换为输入。嘈杂环境或麦克风有底噪时请降低灵敏度。</p>
              <label class="toggle-switch">
                <input type="checkbox" id="dashboard-vad-toggle">
                <span class="slider"></span>
              </label>
              <div class="form-group" style="margin-top:12px">
                <label style="font-size:12px;color:var(--text-secondary)">触发灵敏度：<span id="vad-threshold-display">0.06</span></label>
                <input type="range" id="cfg-vad-threshold" min="0.01" max="0.20" step="0.01" value="0.06" style="width:100%;margin-top:4px">
                <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-secondary);margin-top:2px"><span>高（易触发）</span><span>低（抗噪）</span></div>
              </div>
            </div>
            <div class="card">
              <h3>最近识别记录</h3>
              <div id="history-list" class="history-list">
                <div class="history-empty">暂无识别记录</div>
              </div>
            </div>
          </div>

          <!-- 首选项 -->
          <div id="tab-settings" class="tab-pane">
            <h2 class="page-title">首选项</h2>
            <div class="sub-tabs">
              <button class="sub-tab active" data-subtab="settings-basic">基本设置</button>
              <button class="sub-tab" data-subtab="settings-commands">语音指令</button>
              <button class="sub-tab" data-subtab="settings-hotwords">热词管理</button>
              <button class="sub-tab" data-subtab="settings-text-rules">文本规则</button>
            </div>

            <!-- 子页：基本设置 -->
            <div id="subtab-settings-basic" class="sub-tab-pane active">
              <div class="card">
                <div class="form-group">
                  <label>组合热键 (推入录音)</label>
                  <input id="cfg-hotkey" type="text" class="input" placeholder="Alt+Space" />
                  <span class="tip">长按此键说话。</span>
                </div>
                <div class="form-group">
                  <label>输入设备 (麦克风)</label>
                  <select id="cfg-audio-input-device" class="input">
                    <option value="">系统默认</option>
                  </select>
                  <span class="tip">选择用于录音的麦克风设备。</span>
                </div>
                <div class="form-group row-group">
                  <label class="checkbox">
                    <input id="cfg-clipboard" type="checkbox" />
                    <span>启用剪贴板注入模式 (兼容大部分富文本型病历编辑器)</span>
                  </label>
                </div>
                <div class="form-group row-group">
                  <label class="checkbox">
                    <input id="cfg-log-debug-enabled" type="checkbox" />
                    <span>记录 Debug 日志（默认关闭，开启后会记录更详细诊断日志）</span>
                  </label>
                </div>
                <div class="form-group row-group" style="display:none">
                  <label class="checkbox">
                    <input id="cfg-vad" type="checkbox" />
                    <span>遗留VAD配置(已移到底层)</span>
                  </label>
                </div>
              </div>
              <div class="actions-row">
                <div id="save-hint" class="save-hint"></div>
                <button id="save-btn" class="btn btn-primary">保存设置</button>
              </div>
            </div>

            <!-- 子页：语音指令 -->
            <div id="subtab-settings-commands" class="sub-tab-pane">
              <p class="desc">把常用快捷键和口令绑定，说出口令后系统自动触发对应的键盘快捷键。</p>
              <div class="card">
                <div id="cmd-editor-list" class="cmd-editor-list"></div>
                <button id="add-cmd-btn" class="btn btn-outline">+ 增加映射</button>
              </div>
              <div class="actions-row">
                <div id="cmd-save-hint" class="save-hint"></div>
                <button id="save-cmd-btn" class="btn btn-primary">保存语音指令</button>
              </div>
            </div>

            <!-- 子页：热词管理 -->
            <div id="subtab-settings-hotwords" class="sub-tab-pane">
              <p class="desc">按场景管理 ASR 热词，提升专业术语识别准确率。</p>
              <div class="hotword-scene-bar">
                <div id="scene-tabs" class="scene-tabs"></div>
                <button id="add-scene-btn" class="btn-icon" title="新增场景">+</button>
              </div>
              <div class="card">
                <div class="hotword-input-row">
                  <input id="hotword-search" type="text" class="input hotword-search-input" placeholder="搜索热词..." />
                </div>
                <div class="hotword-input-row">
                  <input id="hotword-input" type="text" class="input hotword-add-input" placeholder="输入热词后按 Enter 添加" />
                </div>
                <div id="hotword-tags" class="hotword-tags"></div>
              </div>
              <div class="actions-row">
                <div id="hotword-save-hint" class="save-hint"></div>
                <button id="save-hotwords-btn" class="btn btn-primary">保存热词</button>
              </div>
            </div>

            <!-- 子页：文本规则 -->
            <div id="subtab-settings-text-rules" class="sub-tab-pane">
              <p class="desc">对 ASR 文本执行可配置的规则化处理（不依赖 LLM）。可用于尺寸表达统一，如“十六厘米乘以十二厘米”→“16CM×12CM”。</p>
              <div class="card">
                <div class="form-group row-group">
                  <label class="checkbox">
                    <input id="cfg-text-rules-enabled" type="checkbox" />
                    <span>启用文本规则引擎</span>
                  </label>
                </div>
                <div class="form-group">
                  <label>规则列表（按顺序执行）</label>
                  <div id="text-rules-editor-list" class="cmd-editor-list text-rules-editor-list"></div>
                  <button id="add-text-rule-btn" class="btn btn-outline" type="button">+ 新增规则</button>
                  <span class="tip">连接词支持逗号分隔，如：乘以，乘，x，×。范围词如：到，至，-。</span>
                </div>
              </div>
              <div class="actions-row">
                <div id="text-rules-save-hint" class="save-hint"></div>
                <button id="save-text-rules-btn" class="btn btn-primary">保存文本规则</button>
              </div>
            </div>
          </div>

          <!-- 模型与任务设置页 -->
          <div id="tab-llm" class="tab-pane">
            <h2 class="page-title">模型与任务设置</h2>
            <div class="sub-tabs">
              <button class="sub-tab active" data-subtab="llm-voice">语音模型</button>
              <button class="sub-tab" data-subtab="llm-models">大模型配置</button>
              <button class="sub-tab" data-subtab="llm-tasks">任务绑定</button>
            </div>

            <!-- 子页：语音模型 -->
            <div id="subtab-llm-voice" class="sub-tab-pane active">
              <div class="card">
                <h3>语音识别模式</h3>
                <div class="asr-mode-selector">
                  <label class="asr-mode-option">
                    <input type="radio" name="asr-mode" value="api" id="asr-mode-api" checked />
                    <div class="asr-mode-card">
                      <div class="asr-mode-title">远程 API</div>
                      <div class="asr-mode-desc">调用服务端 ASR 接口，需要网络连接</div>
                    </div>
                  </label>
                  <label class="asr-mode-option">
                    <input type="radio" name="asr-mode" value="local" id="asr-mode-local" />
                    <div class="asr-mode-card">
                      <div class="asr-mode-title">本地模型</div>
                      <div class="asr-mode-desc">离线运行，无需网络，首次需下载模型</div>
                    </div>
                  </label>
                </div>
              </div>
              <div id="api-settings" class="card">
                <h3>API 设置</h3>
                <div class="form-group">
                  <label>ASR 服务端点地址</label>
                  <input id="cfg-url" type="text" class="input" placeholder="http://localhost:3000" />
                  <span class="tip">部署转写大模型的后台地址</span>
                </div>
              </div>
              <div id="local-model-settings" class="card" style="display:none">
                <h3>本地模型管理</h3>
                <p class="desc" style="margin-bottom:12px">选择并下载 ASR 模型，下载后即可离线使用。</p>
                <div class="form-group row-group">
                  <label class="checkbox">
                    <input id="cfg-local-punc-enabled" type="checkbox" checked />
                    <span>启用本地 PUNC 标点恢复（关闭后可减少本地占用）</span>
                  </label>
                </div>
                <div id="model-integrity-tip" class="model-integrity-tip" style="display:none"></div>
                <div id="model-list-hint" class="model-list-hint" style="display:none"></div>
                <div id="model-list" class="model-list"></div>
              </div>
            </div>

            <!-- 子页：大模型配置 -->
            <div id="subtab-llm-models" class="sub-tab-pane">
              <div class="card">
                <div class="form-group row-group">
                  <label class="checkbox">
                    <input id="cfg-llm-enabled" type="checkbox" />
                    <span>启用划词与语音重写辅助特性 (需设置下方参数)</span>
                  </label>
                </div>
                <div class="form-group row-group">
                  <label class="checkbox">
                    <input id="cfg-llm-asr-optimize" type="checkbox" />
                    <span>启用识别后 LLM 优化（仅非 VAD 模式，且识别文本大于 8 字）</span>
                  </label>
                </div>
                <div class="form-group">
                  <label>模型列表</label>
                  <div id="llm-model-list" class="cmd-editor-list llm-model-list"></div>
                  <button id="llm-add-model-btn" type="button" class="btn btn-outline llm-add-model-btn">新增模型</button>
                  <span class="tip">支持配置多个 OpenAI 兼容模型，可分别绑定到不同任务。</span>
                </div>
              </div>
            </div>

            <!-- 子页：任务绑定 -->
            <div id="subtab-llm-tasks" class="sub-tab-pane">
              <div class="card">
                <div class="task-bind-list">
                  <div class="task-bind-item">
                    <div class="task-bind-header">
                      <label for="cfg-llm-task-rewrite">划词重写</label>
                      <select id="cfg-llm-task-rewrite" class="input">
                        <option value="default-llm">默认模型</option>
                      </select>
                    </div>
                    <p class="task-bind-desc">选中文本后调用大模型进行润色、翻译或改写。推荐使用高质量模型以获得更好的文本效果。</p>
                    <div class="task-prompt-grid">
                      <label for="cfg-llm-prompt-rewrite-system">系统 Prompt</label>
                      <textarea id="cfg-llm-prompt-rewrite-system" class="input task-prompt-input" rows="5"></textarea>
                      <label for="cfg-llm-prompt-rewrite-user">用户 Prompt 模板</label>
                      <textarea id="cfg-llm-prompt-rewrite-user" class="input task-prompt-input" rows="4"
                        placeholder="可用变量：{{instruction}} {{selectedText}}"></textarea>
                    </div>
                  </div>
                  <div class="task-bind-item">
                    <div class="task-bind-header">
                      <label for="cfg-llm-task-asr">语音识别后处理</label>
                      <select id="cfg-llm-task-asr" class="input">
                        <option value="default-llm">默认模型</option>
                      </select>
                    </div>
                    <p class="task-bind-desc">语音识别完成后自动修正错别字、补全标点。每次识别都会调用，推荐使用低延迟的快速模型。</p>
                    <div class="task-prompt-grid">
                      <label for="cfg-llm-prompt-asr-system">系统 Prompt</label>
                      <textarea id="cfg-llm-prompt-asr-system" class="input task-prompt-input" rows="5"></textarea>
                      <label for="cfg-llm-prompt-asr-user">用户 Prompt 模板</label>
                      <textarea id="cfg-llm-prompt-asr-user" class="input task-prompt-input" rows="4"
                        placeholder="可用变量：{{text}}"></textarea>
                    </div>
                  </div>
                  <div class="task-bind-item">
                    <div class="task-bind-header">
                      <label for="cfg-llm-task-summary">每日总结</label>
                      <select id="cfg-llm-task-summary" class="input">
                        <option value="default-llm">默认模型</option>
                      </select>
                    </div>
                    <p class="task-bind-desc">汇总当天所有语音录入内容，提炼有价值的信息。手动触发，推荐使用高质量模型。</p>
                    <div class="task-prompt-grid">
                      <label for="cfg-llm-prompt-summary-system">系统 Prompt</label>
                      <textarea id="cfg-llm-prompt-summary-system" class="input task-prompt-input" rows="5"></textarea>
                      <label for="cfg-llm-prompt-summary-user">用户 Prompt 模板</label>
                      <textarea id="cfg-llm-prompt-summary-user" class="input task-prompt-input" rows="5"
                        placeholder="可用变量：{{count}} {{records}}"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="actions-row">
              <div id="llm-save-hint" class="save-hint"></div>
              <button id="llm-save-btn" class="btn btn-primary">保存设置</button>
            </div>
          </div>

          <!-- 日志页 -->
          <div id="tab-logs" class="tab-pane">
            <h2 class="page-title">运行日志</h2>
            <p class="desc">实时查看应用运行日志，便于排查本地模型和识别问题。</p>
            <div class="log-card">
              <div class="log-toolbar">
                <label class="checkbox log-filter-item">
                  <input id="log-filter-debug" type="checkbox" />
                  <span>Debug</span>
                </label>
                <label class="checkbox log-filter-item">
                  <input id="log-filter-error" type="checkbox" checked />
                  <span>Error</span>
                </label>
                <label class="checkbox log-filter-item">
                  <input id="log-filter-warn" type="checkbox" checked />
                  <span>Warning</span>
                </label>
                <label class="checkbox log-filter-item">
                  <input id="log-filter-info" type="checkbox" />
                  <span>Info</span>
                </label>
                <button id="log-copy-btn" class="btn btn-outline" style="width:auto;padding:6px 12px">复制</button>
                <button id="log-clear-btn" class="btn btn-outline" style="width:auto;padding:6px 12px">清空</button>
              </div>
              <div id="log-container" class="log-container"></div>
            </div>
          </div>

          <!-- 对话记录页 -->
          <div id="tab-history" class="tab-pane">
            <div class="history-page-header">
              <h2 class="page-title">对话记录</h2>
              <button id="daily-summary-btn" class="btn btn-primary">生成今日总结</button>
            </div>
            <div id="full-history-list" class="full-history-list">
              <div class="history-empty">加载中...</div>
            </div>
            <div class="history-load-more-row">
              <button id="history-load-more-btn" class="btn btn-outline" style="width:auto;padding:8px 20px;display:none">加载更多</button>
            </div>
          </div>

        </div>
      </div>

      <!-- 每日总结抽屉 -->
      <div id="summary-drawer" class="summary-drawer" hidden>
        <div class="summary-drawer-backdrop"></div>
        <div class="summary-drawer-panel">
          <div class="summary-drawer-header">
            <h3>每日总结</h3>
            <button id="summary-drawer-close" class="close-dashboard-btn" title="关闭">&times;</button>
          </div>
          <div id="summary-drawer-content" class="summary-drawer-body"></div>
        </div>
      </div>

      <div id="onboarding-overlay" class="onboarding-overlay" hidden>
        <div class="onboarding-dialog">
          <div class="onboarding-header">
            <div class="onboarding-title-wrap">
              <h3>欢迎使用朗珈语音输入法</h3>
              <span id="onboarding-step-index" class="onboarding-step-index">1 / 4</span>
            </div>
            <button id="onboarding-close-btn" class="btn btn-outline onboarding-close-btn">稍后再看</button>
          </div>
          <div class="onboarding-body">
            <div id="onboarding-step-title" class="onboarding-step-title"></div>
            <p id="onboarding-step-desc" class="onboarding-step-desc"></p>
            <ul id="onboarding-step-points" class="onboarding-step-points"></ul>
            <div id="onboarding-step-status" class="onboarding-step-status"></div>
          </div>
          <div class="onboarding-footer">
            <button id="onboarding-secondary-btn" class="btn btn-ghost">跳过</button>
            <button id="onboarding-primary-btn" class="btn btn-primary">下一步</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 视图 3：Rewrite 独立改写窗体 -->
    <div id="rewrite-view" class="view">
      <div class="rewrite-container">
        <div class="rewrite-header">
          <span class="rw-title">
            <img class="rw-brand-logo" src="/brand/langia-logo.png" alt="朗珈语音输入法" />
            <span class="rw-title-main">朗珈语音输入法</span>
            <span class="rw-title-dot">·</span>
            <span class="rw-title-sub">智能重写</span>
          </span>
          <button id="rw-close-btn" class="icon-btn" title="关闭窗口">×</button>
        </div>

        <div class="rw-body">
          <div class="rw-section" style="flex: 0 0 auto;">
            <div class="rw-label">原始文本 (已提取)</div>
            <textarea id="rw-original-text" class="rw-textarea" style="height: 100px; max-height: 120px;" readonly
              placeholder="划词提取内容将显示于此..."></textarea>
          </div>

          <div class="rw-section rw-instruction-section">
            <div class="rw-label">修改意图 (可键入或说话)</div>
            <div class="rw-input-bar">
              <input type="text" id="rw-instruction" class="rw-input" placeholder="请指示如何修改 (如: 语法纠错、语气委婉点)..." />
              <button id="rw-submit-btn" class="btn btn-primary btn-sm">生成</button>
            </div>
          </div>

          <div class="rw-section rw-result-section">
            <div class="rw-label" style="display:flex;justify-content:space-between;align-items:center;">
              <span>改写结果</span>
              <span id="rw-status-indicator" class="rw-status">等待指令</span>
            </div>
            <textarea id="rw-result-text" class="rw-textarea rw-result-textarea"
              placeholder="AI 润色结果将在此处流式生成..."></textarea>
          </div>
        </div>

        <div class="rw-footer">
          <button id="rw-cancel-btn" class="btn-ghost" title="快捷键: Esc">取消</button>
          <button id="rw-copy-btn" class="btn-ghost">复制</button>
          <button id="rw-replace-btn" class="btn-smooth" disabled title="快捷键: Cmd/Ctrl+Enter">替换文本</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>
